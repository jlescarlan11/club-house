<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Group Chat</title>
    <link rel="stylesheet" href="/stylesheets/style.css" />
  </head>
  <!-- 1) turn the body into a full-screen flex column -->
  <body class="flex flex-col h-screen bg-primary">
    <%- include("partials/header") %>

    <main class="container mx-auto pt-24 max-w-2xl h-screen flex flex-col">
      <%- include('partials/errors') %>

      <div class="bg-secondary p-4 mb-4 flex gap-2 rounded-xl items-center">
        <span class="material-symbols-outlined">group</span>
        <p>
          <a href="/membership-form" class="underline hover:text-accent">
            Upgrade to Pro Member
          </a>
          to see user details and chat history
        </p>
      </div>

      <!-- Fixed‐height chat box: 70% of viewport -->
      <div class="bg-accent rounded-2xl shadow-lg flex flex-col h-[70vh]">
        <!-- Messages Container (scrolls when overflow) -->
        <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4">
          <% if (messages && messages.length) { %>
          <p></p>
          <% messages.forEach(message => { %>
          <div
            class="flex <%= message.user_id === user.user_id ? 'justify-end' : 'justify-start' %>"
          >
            <div class="flex flex-col">
              <div
                class="flex text-xs items-center mb-2 font-medium <%= message.user_id === user.user_id ? 'justify-end pr-4' : 'justify-start pl-4' %>"
              >
                <% if (user.is_member) { %>
                <span class="text-text">
                  <%= message.user_id === user.user_id ? 'You' :
                  message.first_name + ' ' + message.last_name %>
                </span>

                <% } else { %>
                <span class="text-text">Anonymous</span>
                <% } %>
              </div>

              <% const d = new Date(message.created_at); const timeOpts = {
              hour: "2-digit", minute: "2-digit" }; const dateOpts = { month:
              "long", day: "numeric", year: "numeric" }; %> <% const ts =
              d.toLocaleTimeString([], timeOpts) + ' · ' +
              d.toLocaleDateString('en-US', dateOpts); %>

              <div
                class="rounded-full px-4 py-2 <%= message.user_id === user.user_id ? 'bg-secondary' : 'bg-primary' %>"
                title="<%= ts %>"
              >
                <p class="text-text"><%= message.content %></p>
              </div>
              <% if (user.is_admin) { %>
              <div class="flex gap-2 mt-2">
                <a
                  href="/messages/edit/<%= message.message_id %>"
                  class="text-xs text-text/80 hover:text-text"
                  >Edit</a
                >
                <form
                  action="/messages/delete/<%= message.message_id %>"
                  method="POST"
                >
                  <button
                    type="submit"
                    class="text-xs text-red-300 hover:text-red-400"
                  >
                    Delete
                  </button>
                </form>
              </div>
              <% } %>
            </div>
          </div>

          <% }) %> <% } else { %>
          <div class="h-full flex items-center justify-center">
            <p class="text-text/60">No messages yet. Start the conversation!</p>
          </div>
          <% } %>
        </div>

        <!-- Message Input -->
        <div class="border-t border-text/10 p-4">
          <form class="flex gap-2">
            <input
              type="text"
              placeholder="Type your message..."
              class="flex-1 bg-primary text-text rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-secondary"
            />
            <button
              type="submit"
              class="bg-secondary text-text px-6 py-2 rounded-xl hover:bg-secondary/80 transition-colors"
            >
              Send
            </button>
          </form>
        </div>
      </div>
    </main>
    <script>
      // Wait until the DOM is fully parsed
      document.addEventListener("DOMContentLoaded", () => {
        const container = document.getElementById("messages");
        if (container) {
          // Jump straight to the bottom of the div
          container.scrollTop = container.scrollHeight;
        }
      });
    </script>
  </body>
</html>
